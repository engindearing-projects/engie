services:
  engie:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: engie
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      SLACK_APP_TOKEN: ${SLACK_APP_TOKEN:-}
      SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN:-}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      GITHUB_TOKEN: ${GITHUB_TOKEN:-}
      OLLAMA_HOST: http://ollama:11434
    volumes:
      - ./config:/home/node/.openclaw
      - ./workspace:/home/node/.openclaw/workspace
      - ./memory:/home/node/.openclaw/memory
      - ./cron:/home/node/.openclaw/cron
    ports:
      - "${ENGIE_GATEWAY_PORT:-18789}:18789"
      - "${ENGIE_BRIDGE_PORT:-18790}:18790"
    init: true
    restart: unless-stopped
    depends_on:
      - ollama
    networks:
      - engie-net

  # CLI service for running one-off commands (channels login, pairing, etc.)
  engie-cli:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: engie-cli
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      SLACK_APP_TOKEN: ${SLACK_APP_TOKEN:-}
      SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN:-}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
    volumes:
      - ./config:/home/node/.openclaw
      - ./workspace:/home/node/.openclaw/workspace
    stdin_open: true
    tty: true
    init: true
    entrypoint: ["node", "/opt/openclaw/openclaw.mjs"]
    profiles:
      - cli
    networks:
      - engie-net

  ollama:
    image: ollama/ollama:latest
    container_name: engie-ollama
    environment:
      OLLAMA_NUM_PARALLEL: "1"
      OLLAMA_MAX_QUEUE: "4"
    volumes:
      - ollama-data:/root/.ollama
    ports:
      - "${OLLAMA_PORT:-11434}:11434"
    restart: unless-stopped
    networks:
      - engie-net
    # On Mac, Ollama uses CPU. On Ubuntu with GPU, add:
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]

volumes:
  ollama-data:

networks:
  engie-net:
    driver: bridge
